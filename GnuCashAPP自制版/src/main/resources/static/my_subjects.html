<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ç§‘ç›® - GNU Cash</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #003366 0%, #004d80 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .page-title {
            text-align: center;
            margin-bottom: 30px;
            color: #003366;
            font-size: 28px;
            font-weight: 700;
        }

        .section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #e0e6ed;
        }

        .section-title {
            font-size: 22px;
            font-weight: 600;
            color: #003366;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #003366 0%, #004d80 100%);
            border-radius: 2px;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .category-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #003366;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .category-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .category-name {
            font-size: 18px;
            font-weight: 600;
            color: #003366;
            flex: 1;
        }

        .category-toggle {
            font-size: 14px;
            color: #6c757d;
            transition: transform 0.3s ease;
        }

        .category-card.collapsed .category-toggle {
            transform: rotate(-90deg);
        }

        .account-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
            transition: max-height 0.3s ease;
        }

        .category-card.collapsed .account-list {
            max-height: 0;
            overflow: hidden;
        }

        .account-item {
            padding: 10px 15px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e6ed;
            transition: all 0.3s ease;
        }

        .account-item:hover {
            border-color: #003366;
            background: #f0f7ff;
        }

        .account-path {
            font-weight: 500;
            color: #2c3e50;
        }

        .account-type {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            background: #e6f0ff;
            color: #003366;
            margin-left: 10px;
        }

        .new-application-btn {
            background: linear-gradient(135deg, #003366 0%, #004d80 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .new-application-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 51, 102, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #003366;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }

        .close-btn:hover {
            color: #003366;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #003366;
            box-shadow: 0 0 0 2px rgba(0, 51, 102, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #003366 0%, #004d80 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 10px rgba(0, 51, 102, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .applications-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }

        .applications-table th,
        .applications-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e6ed;
            vertical-align: top;
        }

        .applications-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            white-space: nowrap;
        }

        .applications-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 8px;
            margin: 20px 0;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .category-grid {
                grid-template-columns: 1fr;
            }
            
            .applications-table {
                font-size: 12px;
            }
            
            .applications-table th,
            .applications-table td {
                padding: 8px 10px;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">GNU Cash è´¢åŠ¡è®°è´¦è½¯ä»¶</div>
            <a href="user_main.html" class="back-btn">è¿”å›ä¸»é¡µ</a>
        </div>
    </header>

    <div class="container">
        <h1 class="page-title">æˆ‘çš„ç§‘ç›®</h1>

        <!-- ç°æœ‰ç§‘ç›®éƒ¨åˆ† -->
        <div class="section">
            <h2 class="section-title">ğŸ“š ç°æœ‰ç§‘ç›®</h2>
            <div id="accounts-container" class="loading">
                æ­£åœ¨åŠ è½½ç§‘ç›®æ•°æ®...
            </div>
        </div>

        <!-- æˆ‘çš„ç”³è¯·éƒ¨åˆ† -->
        <div class="section">
            <h2 class="section-title">ğŸ“‹ æˆ‘çš„ç”³è¯·</h2>
            <button class="new-application-btn" onclick="showNewApplicationModal()">+ æäº¤æ–°ç”³è¯·</button>

        </div>

        <!-- æäº¤æ–°ç”³è¯·æ¨¡æ€æ¡† -->
        <div id="newApplicationModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">æäº¤æ–°ç§‘ç›®ç”³è¯·</h3>
                    <button class="close-btn" onclick="hideNewApplicationModal()">&times;</button>
                </div>
                <form id="newApplicationForm">
                    <div class="form-group">
                        <label class="form-label">ç§‘ç›®ç±»åˆ«</label>
                        <select class="form-select" id="category" required>
                            <option value="">è¯·é€‰æ‹©ç±»åˆ«</option>
                            <option value="èµ„äº§">èµ„äº§</option>
                            <option value="è´Ÿå€º">è´Ÿå€º</option>
                            <option value="æ‰€æœ‰è€…æƒç›Š">æ‰€æœ‰è€…æƒç›Š</option>
                            <option value="æ”¶å…¥">æ”¶å…¥</option>
                            <option value="æ”¯å‡º">æ”¯å‡º</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ä¸€çº§ç§‘ç›®</label>
                        <input type="text" class="form-input" id="level1" placeholder="è¯·è¾“å…¥ä¸€çº§ç§‘ç›®åç§°" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">äºŒçº§ç§‘ç›®</label>
                        <input type="text" class="form-input" id="level2" placeholder="è¯·è¾“å…¥äºŒçº§ç§‘ç›®åç§°ï¼ˆå¯é€‰ï¼‰">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ä¸‰çº§ç§‘ç›®</label>
                        <input type="text" class="form-input" id="level3" placeholder="è¯·è¾“å…¥ä¸‰çº§ç§‘ç›®åç§°ï¼ˆå¯é€‰ï¼‰">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç”³è¯·åŸå› </label>
                        <textarea class="form-textarea" id="applicationReason" placeholder="è¯·è¯¦ç»†è¯´æ˜ç”³è¯·è¯¥ç§‘ç›®çš„åŸå› å’Œç”¨é€”" required></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="hideNewApplicationModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">æäº¤ç”³è¯·</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="applications-container" class="loading">
         </div>
    </div>

    <script>
        const API_BASE = 'http://123.207.197.116:8081';
        
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // åŠ è½½ç§‘ç›®æ•°æ®
            loadAccounts();
            
            // åŠ è½½ç”³è¯·æ•°æ®
            loadApplications();
        });

        // åŠ è½½ç§‘ç›®æ•°æ®
        async function loadAccounts() {
            const container = document.getElementById('accounts-container');
            
            try {
                const response = await fetch(`${API_BASE}/api/accounts/common`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                displayAccounts(data);
                
            } catch (error) {
                console.error('åŠ è½½ç§‘ç›®æ•°æ®å¤±è´¥:', error);
                container.innerHTML = `
                    <div class="error">
                        <h3>åŠ è½½å¤±è´¥</h3>
                        <p>æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>
                        <button onclick="loadAccounts()" class="back-btn" style="margin-top: 10px;">é‡è¯•</button>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºç§‘ç›®æ•°æ®
        function displayAccounts(data) {
            const container = document.getElementById('accounts-container');
            
            if (!data || Object.keys(data).length === 0) {
                container.innerHTML = '<div class="no-data">æš‚æ— ç§‘ç›®æ•°æ®</div>';
                return;
            }

            const categories = [
                { key: 'assets', name: 'èµ„äº§', icon: 'ğŸ’°', color: '#28a745' },
                { key: 'liabilities', name: 'è´Ÿå€º', icon: 'ğŸ’³', color: '#dc3545' },
                { key: 'equity', name: 'æ‰€æœ‰è€…æƒç›Š', icon: 'ğŸ¢', color: '#007bff' },
                { key: 'income', name: 'æ”¶å…¥', icon: 'ğŸ“ˆ', color: '#20c997' },
                { key: 'expenses', name: 'æ”¯å‡º', icon: 'ğŸ“‰', color: '#fd7e14' }
            ];

            let html = '<div class="category-grid">';
            
            categories.forEach(category => {
                const accounts = data[category.key] || [];
                
                if (accounts.length > 0) {
                    html += `
                        <div class="category-card collapsed">
                            <div class="category-header" onclick="toggleCategory(this.parentElement)">
                                <div class="category-icon" style="background-color: ${category.color};">
                                    ${category.icon}
                                </div>
                                <div class="category-name">${category.name}</div>
                                <span style="font-size: 12px; color: #6c757d;">(${accounts.length}ä¸ªç§‘ç›®)</span>
                                <span class="category-toggle">â–¼</span>
                            </div>
                            <ul class="account-list">
                    `;
                    
                    accounts.forEach(account => {
                        html += `
                            <li class="account-item">
                                <div class="account-path">${account.name}</div>
                                <span class="account-type">${account.accountType}</span>
                            </li>
                        `;
                    });
                    
                    html += `
                            </ul>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // åŠ è½½ç”³è¯·æ•°æ®
        async function loadApplications() {
            const container = document.getElementById('applications-container');
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            try {
                const response = await fetch(`${API_BASE}/api/account-application`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                // è¿‡æ»¤å½“å‰ç”¨æˆ·çš„ç”³è¯·
                const myApplications = data.filter(app => app.applicantId === currentUser.id);
                displayApplications(myApplications);
                
            } catch (error) {
                console.error('åŠ è½½ç”³è¯·æ•°æ®å¤±è´¥:', error);
                container.innerHTML = `
                    <div class="error">
                        <h3>åŠ è½½å¤±è´¥</h3>
                        <p>æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>
                        <button onclick="loadApplications()" class="back-btn" style="margin-top: 10px;">é‡è¯•</button>
                    </div>
                `;
            }
        }

        // åˆ‡æ¢ç§‘ç›®ç±»åˆ«æŠ˜å çŠ¶æ€
        function toggleCategory(element) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…ç‚¹å‡»å¡ç‰‡æ—¶è§¦å‘æŠ˜å 
            event.stopPropagation();
            element.classList.toggle('collapsed');
        }

        // æ˜¾ç¤ºç§‘ç›®æ•°æ®
        function displayAccounts(data) {
            const container = document.getElementById('accounts-container');
            
            if (!data || Object.keys(data).length === 0) {
                container.innerHTML = '<div class="no-data">æš‚æ— ç§‘ç›®æ•°æ®</div>';
                return;
            }

            const categories = [
                { key: 'assets', name: 'èµ„äº§', icon: 'ğŸ’°', color: '#28a745' },
                { key: 'liabilities', name: 'è´Ÿå€º', icon: 'ğŸ’³', color: '#dc3545' },
                { key: 'equity', name: 'æ‰€æœ‰è€…æƒç›Š', icon: 'ğŸ¢', color: '#007bff' },
                { key: 'income', name: 'æ”¶å…¥', icon: 'ğŸ“ˆ', color: '#20c997' },
                { key: 'expenses', name: 'æ”¯å‡º', icon: 'ğŸ“‰', color: '#fd7e14' }
            ];

            let html = '<div class="category-grid">';
            
            categories.forEach(category => {
                const accounts = data[category.key] || [];
                
                if (accounts.length > 0) {
                    html += `
                        <div class="category-card collapsed">
                            <div class="category-header" onclick="toggleCategory(this.parentElement)">
                                <div class="category-icon" style="background-color: ${category.color};">
                                    ${category.icon}
                                </div>
                                <div class="category-name">${category.name}</div>
                                <span style="font-size: 12px; color: #6c757d;">(${accounts.length}ä¸ªç§‘ç›®)</span>
                                <span class="category-toggle">â–¼</span>
                            </div>
                            <ul class="account-list">
                    `;
                    
                    accounts.forEach(account => {
                        html += `
                            <li class="account-item">
                                <div class="account-path">${account.name}</div>
                                <span class="account-type">${account.accountType}</span>
                            </li>
                        `;
                    });
                    
                    html += `
                            </ul>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // æ˜¾ç¤ºæ–°ç”³è¯·æ¨¡æ€æ¡†
        function showNewApplicationModal() {
            document.getElementById('newApplicationModal').style.display = 'block';
        }

        // éšè—æ–°ç”³è¯·æ¨¡æ€æ¡†
        function hideNewApplicationModal() {
            document.getElementById('newApplicationModal').style.display = 'none';
        }

        // å¤„ç†æ–°ç”³è¯·è¡¨å•æäº¤
        document.getElementById('newApplicationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const formData = {
                category: document.getElementById('category').value,
                level1: document.getElementById('level1').value,
                level2: document.getElementById('level2').value || null,
                level3: document.getElementById('level3').value || null,
                applicationReason: document.getElementById('applicationReason').value,
                applicantId: currentUser.id,
                applicantName: currentUser.username,
                applicationTime: new Date().toISOString(),
                status: 'å¾…å®¡æ‰¹'
            };

            try {
                const response = await fetch(`${API_BASE}/api/account-application`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                alert('ç”³è¯·æäº¤æˆåŠŸï¼');
                hideNewApplicationModal();
                // é‡ç½®è¡¨å•
                document.getElementById('newApplicationForm').reset();
                // é‡æ–°åŠ è½½ç”³è¯·æ•°æ®
                loadApplications();
                
            } catch (error) {
                console.error('æäº¤ç”³è¯·å¤±è´¥:', error);
                alert('æäº¤ç”³è¯·å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });

        // æ˜¾ç¤ºç”³è¯·æ•°æ®
        function displayApplications(applications) {
            const container = document.getElementById('applications-container');
            
            if (!applications || applications.length === 0) {
                container.innerHTML = '<div class="no-data">æš‚æ— ç”³è¯·è®°å½•</div>';
                return;
            }

            let html = `
                <table class="applications-table">
                    <thead>
                        <tr>
                            <th>ç”³è¯·ID</th>
                            <th>ç§‘ç›®ç±»åˆ«</th>
                            <th>ä¸€çº§ç§‘ç›®</th>
                            <th>äºŒçº§ç§‘ç›®</th>
                            <th>ä¸‰çº§ç§‘ç›®</th>
                            <th>ç”³è¯·åŸå› </th>
                            <th>ç”³è¯·äºº</th>
                            <th>ç”³è¯·æ—¶é—´</th>
                            <th>çŠ¶æ€</th>
                            <th>å®¡æ ¸äºº</th>
                            <th>å®¡æ ¸æ—¶é—´</th>
                            <th>å®¡æ ¸æ„è§</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            applications.forEach(app => {
                const statusClass = getStatusClass(app.status);
                const applicationTime = new Date(app.applicationTime).toLocaleString('zh-CN');
                const reviewTime = app.reviewTime ? new Date(app.reviewTime).toLocaleString('zh-CN') : '-';
                // ä¿®æ­£å®¡æ ¸äººæ˜¾ç¤ºé€»è¾‘ï¼šé»˜è®¤æ˜¾ç¤ºç³»ç»Ÿç®¡ç†å‘˜
                const reviewerName = app.reviewerName || 'ç³»ç»Ÿç®¡ç†å‘˜';
                
                html += `
                    <tr>
                        <td>${app.id}</td>
                        <td>${app.category}</td>
                        <td>${app.level1 || '-'}</td>
                        <td>${app.level2 || '-'}</td>
                        <td>${app.level3 || '-'}</td>
                        <td title="${app.applicationReason}">${truncateText(app.applicationReason, 30)}</td>
                        <td>${app.applicantName}</td>
                        <td>${applicationTime}</td>
                        <td><span class="status-badge ${statusClass}">${app.status}</span></td>
                        <td>${reviewerName}</td>
                        <td>${reviewTime}</td>
                        <td title="${app.reviewComment || ''}">${truncateText(app.reviewComment || '-', 20)}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                <div style="margin-top: 15px; color: #6c757d; font-size: 14px;">
                    å…± ${applications.length} æ¡ç”³è¯·è®°å½•
                </div>
            `;
            
            container.innerHTML = html;
        }

        // è·å–çŠ¶æ€å¯¹åº”çš„CSSç±»
        function getStatusClass(status) {
            switch (status) {
                case 'å¾…å®¡æ‰¹': return 'status-pending';
                case 'å·²é€šè¿‡': return 'status-approved';
                case 'å·²æ‹’ç»': return 'status-rejected';
                default: return 'status-pending';
            }
        }

        // æˆªæ–­æ–‡æœ¬
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
    </script>
</body>
</html>