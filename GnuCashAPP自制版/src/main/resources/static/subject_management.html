<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘ç›®ç®¡ç† - GNU Cash è´¢åŠ¡è®°è´¦è½¯ä»¶</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #003366 0%, #004d80 100%);
            min-height: 100vh;
            color: #333;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 30px 20px;
            border-bottom: 1px solid rgba(0, 51, 102, 0.1);
            text-align: center;
        }

        .sidebar-header h1 {
            color: #003366;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            color: #666;
            font-size: 12px;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: #555;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: rgba(0, 51, 102, 0.05);
            color: #003366;
            border-left-color: #003366;
        }

        .menu-item.active {
            background: rgba(0, 51, 102, 0.1);
            color: #003366;
            border-left-color: #003366;
            font-weight: 600;
        }

        .menu-item i {
            margin-right: 12px;
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .content-header h2 {
            color: white;
            font-size: 28px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* å†…å®¹åŒºåŸŸæ ·å¼ */
        .content-area {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            min-height: 500px;
        }

        /* å·¥å…·æ æ ·å¼ */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .search-box {
            display: flex;
            gap: 10px;
        }

        .search-input {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            width: 300px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin: 2px;
        }

        .btn-primary {
            background: #003366;
            color: white;
        }

        .btn-primary:hover {
            background: #004d80;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-1px);
        }

        /* ç§‘ç›®ç±»åˆ«ç½‘æ ¼æ ·å¼ */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .category-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #003366;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .category-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .category-name {
            font-size: 18px;
            font-weight: 600;
            color: #003366;
            flex: 1;
        }

        .category-toggle {
            font-size: 14px;
            color: #6c757d;
            transition: transform 0.3s ease;
        }

        .category-card.collapsed .category-toggle {
            transform: rotate(-90deg);
        }

        .account-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
            transition: max-height 0.3s ease;
        }

        .category-card.collapsed .account-list {
            max-height: 0;
            overflow: hidden;
        }

        .account-item {
            padding: 10px 15px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e6ed;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .account-item:hover {
            border-color: #003366;
            background: #f0f7ff;
        }

        .account-path {
            font-weight: 500;
            color: #2c3e50;
            flex: 1;
        }

        .account-type {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            background: #e6f0ff;
            color: #003366;
            margin-left: 10px;
        }

        .account-actions {
            display: flex;
            gap: 5px;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .data-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #003366;
            border-bottom: 2px solid #e9ecef;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h3 {
            color: #003366;
            font-size: 20px;
            font-weight: 600;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #003366;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #003366;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fafbfc;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: #003366;
            box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
            background: white;
            transform: translateY(-1px);
        }

        .form-control:hover {
            border-color: #cbd5e0;
            background: #f8f9fa;
        }

        .form-control::placeholder {
            color: #a0aec0;
            font-weight: 400;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 8px;
            margin: 20px 0;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .content-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .toolbar {
                flex-direction: column;
                gap: 15px;
            }
            
            .search-box {
                width: 100%;
            }
            
            .search-input {
                width: 100%;
            }
            
            .category-grid {
                grid-template-columns: 1fr;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 10px;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>GNU Cash</h1>
                <p>è´¢åŠ¡è®°è´¦è½¯ä»¶åå°</p>
            </div>
            
            <div class="sidebar-menu">
                <a href="admin_dashboard.html" class="menu-item">
                    <i class="fas fa-home"></i>
                    <span>é¦–é¡µ</span>
                </a>
                <a href="user_management.html" class="menu-item">
                    <i class="fas fa-users"></i>
                    <span>ç”¨æˆ·ç®¡ç†</span>
                </a>
                <a href="subject_management.html" class="menu-item active">
                    <i class="fas fa-book"></i>
                    <span>ç§‘ç›®ç®¡ç†</span>
                </a>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <div class="content-header">
                <h2>ç§‘ç›®ç®¡ç†</h2>
                <div class="user-info">
                    <span>ç®¡ç†å‘˜</span>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> é€€å‡ºç™»å½•
                    </button>
                </div>
            </div>

            <!-- ç§‘ç›®ç®¡ç†åŒºåŸŸ -->
            <div class="content-area">
                <div class="toolbar">
                    <h3>ç§‘ç›®åˆ—è¡¨</h3>
                    <div class="search-box">
                        <input type="text" id="subjectSearch" class="search-input" placeholder="æœç´¢ç§‘ç›®åç§°..." onkeyup="searchSubjects()">
                        <button class="btn btn-primary" onclick="showAddSubjectModal()">
                            <i class="fas fa-plus"></i> æ·»åŠ ç§‘ç›®
                        </button>
                    </div>
                </div>

                <!-- ç§‘ç›®ç±»åˆ«å±•ç¤º -->
                <div class="section">
                    <h3 class="section-title">ğŸ“š æ‰€æœ‰ç§‘ç›®</h3>
                    <div id="subjects-container" class="loading">
                        æ­£åœ¨åŠ è½½ç§‘ç›®æ•°æ®...
                    </div>
                </div>

                <!-- ç§‘ç›®ç”³è¯·ç®¡ç† -->
                <div class="section">
                    <h3 class="section-title">ğŸ“‹ ç§‘ç›®ç”³è¯·å®¡æ‰¹</h3>
                    <div id="applications-container" class="loading">
                        æ­£åœ¨åŠ è½½ç”³è¯·æ•°æ®...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ ç§‘ç›®æ¨¡æ€æ¡† -->
    <div id="addSubjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ ç§‘ç›®</h3>
                <span class="close" onclick="hideAddSubjectModal()">&times;</span>
            </div>
            
            <form id="addSubjectForm">
                <div class="form-group">
                    <label for="subjectCategory">ç§‘ç›®ç±»åˆ«</label>
                    <select class="form-control" id="subjectCategory" required>
                        <option value="">è¯·é€‰æ‹©ç§‘ç›®ç±»åˆ«</option>
                        <option value="assets">èµ„äº§</option>
                        <option value="liabilities">è´Ÿå€º</option>
                        <option value="equity">æ‰€æœ‰è€…æƒç›Š</option>
                        <option value="income">æ”¶å…¥</option>
                        <option value="expenses">æ”¯å‡º</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="subjectName">ä¸€çº§ç§‘ç›®åç§° *</label>
                    <input type="text" class="form-control" id="subjectName" placeholder="è¯·è¾“å…¥ä¸€çº§ç§‘ç›®åç§°" required>
                </div>
                
                <div class="form-group">
                    <label for="subjectLevel2">äºŒçº§ç§‘ç›®åç§°</label>
                    <input type="text" class="form-control" id="subjectLevel2" placeholder="è¯·è¾“å…¥äºŒçº§ç§‘ç›®åç§°ï¼ˆé€‰å¡«ï¼‰">
                </div>
                
                <div class="form-group">
                    <label for="subjectLevel3">ä¸‰çº§ç§‘ç›®åç§°</label>
                    <input type="text" class="form-control" id="subjectLevel3" placeholder="è¯·è¾“å…¥ä¸‰çº§ç§‘ç›®åç§°ï¼ˆé€‰å¡«ï¼‰">
                </div>
                
                <div class="form-group">
                    <label for="subjectDescription">ç§‘ç›®æè¿°</label>
                    <textarea class="form-control" id="subjectDescription" placeholder="è¯·è¾“å…¥ç§‘ç›®æè¿°ï¼ˆé€‰å¡«ï¼‰" rows="3"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideAddSubjectModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">æ·»åŠ ç§‘ç›®</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å®¡æ‰¹ç”³è¯·æ¨¡æ€æ¡† -->
    <div id="reviewApplicationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å®¡æ‰¹ç§‘ç›®ç”³è¯·</h3>
                <span class="close" onclick="hideReviewApplicationModal()">&times;</span>
            </div>
            
            <form id="reviewApplicationForm">
                <div class="form-group">
                    <label>ç”³è¯·ä¿¡æ¯</label>
                    <div id="applicationDetails" style="background: #f8f9fa; padding: 15px; border-radius: 6px;"></div>
                </div>
                
                <div class="form-group">
                    <label for="reviewStatus">å®¡æ‰¹çŠ¶æ€</label>
                    <select class="form-control" id="reviewStatus" required>
                        <option value="">è¯·é€‰æ‹©çŠ¶æ€</option>
                        <option value="approved">é€šè¿‡</option>
                        <option value="rejected">æ‹’ç»</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="reviewComment">å®¡æ‰¹æ„è§</label>
                    <textarea class="form-control" id="reviewComment" placeholder="è¯·è¾“å…¥å®¡æ‰¹æ„è§" rows="3" required></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideReviewApplicationModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">æäº¤å®¡æ‰¹</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://123.207.197.116:8081';
        
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç®¡ç†å‘˜ç™»å½•çŠ¶æ€
            const currentAdmin = localStorage.getItem('currentAdmin');
            if (!currentAdmin) {
             }

            // åŠ è½½æ‰€æœ‰ç§‘ç›®æ•°æ®
            loadAllSubjects();
            
            // åŠ è½½æ‰€æœ‰ç”³è¯·æ•°æ®
            loadAllApplications();
        });

        // åŠ è½½æ‰€æœ‰ç§‘ç›®æ•°æ®ï¼ˆç®¡ç†å‘˜ç«¯æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·ç§‘ç›®ï¼‰
        async function loadAllSubjects() {
            const container = document.getElementById('subjects-container');
            
            try {
                const response = await fetch(`${API_BASE}/api/accounts/common`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                displayAllSubjects(data);
                
            } catch (error) {
                console.error('åŠ è½½ç§‘ç›®æ•°æ®å¤±è´¥:', error);
                container.innerHTML = `
                    <div class="error">
                        <h3>åŠ è½½å¤±è´¥</h3>
                        <p>æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>
                        <button onclick="loadAllSubjects()" class="btn btn-primary" style="margin-top: 10px;">é‡è¯•</button>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºæ‰€æœ‰ç§‘ç›®æ•°æ®
        function displayAllSubjects(data) {
            const container = document.getElementById('subjects-container');
            
            if (!data || Object.keys(data).length === 0) {
                container.innerHTML = '<div class="no-data">æš‚æ— ç§‘ç›®æ•°æ®</div>';
                return;
            }

            const categories = [
                { key: 'assets', name: 'èµ„äº§', icon: 'ğŸ’°', color: '#28a745' },
                { key: 'liabilities', name: 'è´Ÿå€º', icon: 'ğŸ’³', color: '#dc3545' },
                { key: 'equity', name: 'æ‰€æœ‰è€…æƒç›Š', icon: 'ğŸ¢', color: '#007bff' },
                { key: 'income', name: 'æ”¶å…¥', icon: 'ğŸ“ˆ', color: '#20c997' },
                { key: 'expenses', name: 'æ”¯å‡º', icon: 'ğŸ“‰', color: '#fd7e14' }
            ];

            let html = '<div class="category-grid">';
            
            categories.forEach(category => {
                const accounts = data[category.key] || [];
                
                if (accounts.length > 0) {
                    html += `
                        <div class="category-card collapsed">
                            <div class="category-header" onclick="toggleCategory(this.parentElement)">
                                <div class="category-icon" style="background-color: ${category.color};">
                                    ${category.icon}
                                </div>
                                <div class="category-name">${category.name}</div>
                                <span style="font-size: 12px; color: #6c757d;">(${accounts.length}ä¸ªç§‘ç›®)</span>
                                <span class="category-toggle">â–¼</span>
                            </div>
                            <ul class="account-list">
                    `;
                    
                    accounts.forEach(account => {
                        html += `
                            <li class="account-item">
                                <div class="account-path">${account.name}</div>
                                <span class="account-type">${account.accountType}</span>
                            </li>
                        `;
                    });
                    
                    html += `
                            </ul>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // åŠ è½½æ‰€æœ‰ç”³è¯·æ•°æ®ï¼ˆç®¡ç†å‘˜ç«¯æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·ç”³è¯·ï¼‰
        async function loadAllApplications() {
            const container = document.getElementById('applications-container');
            
            try {
                const response = await fetch(`${API_BASE}/api/account-application`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                // ç®¡ç†å‘˜ç«¯æ˜¾ç¤ºæ‰€æœ‰ç”³è¯·ï¼Œä¸è¿‡æ»¤
                displayAllApplications(data);
                
            } catch (error) {
                console.error('åŠ è½½ç”³è¯·æ•°æ®å¤±è´¥:', error);
                container.innerHTML = `
                    <div class="error">
                        <h3>åŠ è½½å¤±è´¥</h3>
                        <p>æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>
                        <button onclick="loadAllApplications()" class="btn btn-primary" style="margin-top: 10px;">é‡è¯•</button>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºæ‰€æœ‰ç”³è¯·æ•°æ®
        function displayAllApplications(applications) {
            const container = document.getElementById('applications-container');
            
            if (!applications || applications.length === 0) {
                container.innerHTML = '<div class="no-data">æš‚æ— ç”³è¯·è®°å½•</div>';
                return;
            }

            let html = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ç”³è¯·ID</th>
                                <th>ç§‘ç›®ç±»åˆ«</th>
                                <th>ä¸€çº§ç§‘ç›®</th>
                                <th>äºŒçº§ç§‘ç›®</th>
                                <th>ä¸‰çº§ç§‘ç›®</th>
                                <th>ç”³è¯·åŸå› </th>
                                <th>ç”³è¯·äºº</th>
                                <th>ç”³è¯·æ—¶é—´</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            applications.forEach(app => {
                const statusClass = getStatusClass(app.status);
                const applicationTime = new Date(app.applicationTime).toLocaleString('zh-CN');
                
                html += `
                    <tr>
                        <td>${app.id}</td>
                        <td>${app.category}</td>
                        <td>${app.level1 || '-'}</td>
                        <td>${app.level2 || '-'}</td>
                        <td>${app.level3 || '-'}</td>
                        <td title="${app.applicationReason}">${truncateText(app.applicationReason, 30)}</td>
                        <td>${app.applicantName}</td>
                        <td>${applicationTime}</td>
                        <td><span class="status-badge ${statusClass}">${app.status}</span></td>
                        <td>
                `;
                
                if (app.status === 'å¾…å®¡æ‰¹') {
                    html += `
                        <button class="btn btn-success btn-sm" onclick="reviewApplication('${app.id}')">å®¡æ‰¹</button>
                    `;
                } else {
                    html += `
                        <button class="btn btn-secondary btn-sm" disabled>å·²å¤„ç†</button>
                    `;
                }
                
                html += `
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                    <div style="margin-top: 15px; color: #6c757d; font-size: 14px;">
                        å…± ${applications.length} æ¡ç”³è¯·è®°å½•
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // åˆ‡æ¢ç§‘ç›®ç±»åˆ«æŠ˜å çŠ¶æ€
        function toggleCategory(element) {
            event.stopPropagation();
            element.classList.toggle('collapsed');
        }

        // æ˜¾ç¤ºæ·»åŠ ç§‘ç›®æ¨¡æ€æ¡†
        function showAddSubjectModal() {
            document.getElementById('addSubjectModal').style.display = 'block';
        }

        // éšè—æ·»åŠ ç§‘ç›®æ¨¡æ€æ¡†
        function hideAddSubjectModal() {
            document.getElementById('addSubjectModal').style.display = 'none';
        }

        // æ˜¾ç¤ºå®¡æ‰¹ç”³è¯·æ¨¡æ€æ¡†
        function showReviewApplicationModal(applicationId) {
            const application = getApplicationById(applicationId);
            if (application) {
                document.getElementById('applicationDetails').innerHTML = `
                    <div><strong>ç”³è¯·äººï¼š</strong>${application.applicantName}</div>
                    <div><strong>ç§‘ç›®ç±»åˆ«ï¼š</strong>${application.category}</div>
                    <div><strong>ä¸€çº§ç§‘ç›®ï¼š</strong>${application.level1 || '-'}</div>
                    <div><strong>äºŒçº§ç§‘ç›®ï¼š</strong>${application.level2 || '-'}</div>
                    <div><strong>ä¸‰çº§ç§‘ç›®ï¼š</strong>${application.level3 || '-'}</div>
                    <div><strong>ç”³è¯·åŸå› ï¼š</strong>${application.applicationReason}</div>
                `;
                document.getElementById('reviewApplicationForm').dataset.applicationId = applicationId;
                document.getElementById('reviewApplicationModal').style.display = 'block';
            }
        }

        // éšè—å®¡æ‰¹ç”³è¯·æ¨¡æ€æ¡†
        function hideReviewApplicationModal() {
            document.getElementById('reviewApplicationModal').style.display = 'none';
        }

        // å¤„ç†æ·»åŠ ç§‘ç›®è¡¨å•æäº¤
        document.getElementById('addSubjectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const category = document.getElementById('subjectCategory').value;
            const categoryMap = {
                'assets': 'èµ„äº§',
                'liabilities': 'è´Ÿå€º', 
                'equity': 'æ‰€æœ‰è€…æƒç›Š',
                'income': 'æ”¶å…¥',
                'expenses': 'æ”¯å‡º'
            };
            
            const formData = {
                category: categoryMap[category] || category,
                level1: document.getElementById('subjectName').value,
                level2: document.getElementById('subjectLevel2').value || '',
                level3: document.getElementById('subjectLevel3').value || '',
                description: document.getElementById('subjectDescription').value || '',
                createdBy: 'admin',
                createdAt: new Date().toISOString()
            };

            try {
                const response = await fetch(`${API_BASE}/api/account-application/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                alert('ç§‘ç›®æ·»åŠ æˆåŠŸï¼');
                hideAddSubjectModal();
                document.getElementById('addSubjectForm').reset();
                loadAllSubjects();
                
            } catch (error) {
                console.error('æ·»åŠ ç§‘ç›®å¤±è´¥:', error);
                alert('æ·»åŠ ç§‘ç›®å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });

        // å¤„ç†å®¡æ‰¹ç”³è¯·è¡¨å•æäº¤
        document.getElementById('reviewApplicationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const applicationId = this.dataset.applicationId;
            
            const reviewData = {
                status: document.getElementById('reviewStatus').value === 'approved' ? 'å·²é€šè¿‡' : 'å·²æ‹’ç»',
                reviewComment: document.getElementById('reviewComment').value,
                reviewerId: 1, // é»˜è®¤ç®¡ç†å‘˜ID
                reviewerName: 'ç®¡ç†å‘˜',
                reviewTime: new Date().toISOString()
            };

            try {
                const response = await fetch(`${API_BASE}/api/account-application/${applicationId}/review`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(reviewData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                alert('å®¡æ‰¹æäº¤æˆåŠŸï¼');
                hideReviewApplicationModal();
                document.getElementById('reviewApplicationForm').reset();
                loadAllApplications();
                
            } catch (error) {
                console.error('å®¡æ‰¹æäº¤å¤±è´¥:', error);
                alert('å®¡æ‰¹æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });

        // æœç´¢ç§‘ç›®
        function searchSubjects() {
            const searchTerm = document.getElementById('subjectSearch').value.toLowerCase();
            const accountItems = document.querySelectorAll('.account-item');
            
            accountItems.forEach(item => {
                const accountPath = item.querySelector('.account-path').textContent.toLowerCase();
                if (accountPath.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // å®¡æ‰¹ç”³è¯·
        function reviewApplication(applicationId) {
            showReviewApplicationModal(applicationId);
        }

        // æ ¹æ®IDè·å–ç”³è¯·ä¿¡æ¯
        function getApplicationById(applicationId) {
            // è¿™é‡Œéœ€è¦ä»å½“å‰åŠ è½½çš„ç”³è¯·æ•°æ®ä¸­æŸ¥æ‰¾
            const applications = window.currentApplications || [];
            // ç¡®ä¿applicationIdæ˜¯å­—ç¬¦ä¸²ç±»å‹è¿›è¡Œæ¯”è¾ƒ
            return applications.find(app => app.id.toString() === applicationId.toString());
        }

        // è·å–çŠ¶æ€å¯¹åº”çš„CSSç±»
        function getStatusClass(status) {
            switch (status) {
                case 'å¾…å®¡æ‰¹': return 'status-pending';
                case 'å·²é€šè¿‡': return 'status-approved';
                case 'å·²æ‹’ç»': return 'status-rejected';
                default: return 'status-pending';
            }
        }

        // æ–‡æœ¬æˆªæ–­
        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('currentAdmin');
                window.location.href = 'admin_login.html';
            }
        }

        // ä¿å­˜å½“å‰ç”³è¯·æ•°æ®åˆ°å…¨å±€å˜é‡
        window.currentApplications = [];
        
        // ä¿®æ”¹loadAllApplicationså‡½æ•°ï¼Œä¿å­˜ç”³è¯·æ•°æ®
        const originalLoadAllApplications = loadAllApplications;
        loadAllApplications = async function() {
            const container = document.getElementById('applications-container');
            
            try {
                const response = await fetch(`${API_BASE}/api/account-application`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                window.currentApplications = data;
                displayAllApplications(data);
                
            } catch (error) {
                console.error('åŠ è½½ç”³è¯·æ•°æ®å¤±è´¥:', error);
                container.innerHTML = `
                    <div class="error">
                        <h3>åŠ è½½å¤±è´¥</h3>
                        <p>æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>
                        <button onclick="loadAllApplications()" class="btn btn-primary" style="margin-top: 10px;">é‡è¯•</button>
                    </div>
                `;
            }
        };

        // æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>