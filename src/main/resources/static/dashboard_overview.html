<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GNU Cash 财务记账软件 - 数据概览</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #e6f0ff 0%, #f0f2f5 100%);
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #003366 0%, #004d80 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .page-title {
            font-size: 32px;
            color: #003366;
            margin-bottom: 30px;
            font-weight: 700;
            text-align: center;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 4px solid #004d80;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .summary-card.negative {
            border-left-color: #e74c3c;
        }

        .summary-card.positive {
            border-left-color: #2ecc71;
        }

        .summary-value {
            font-size: 32px;
            font-weight: 700;
            color: #003366;
            margin-bottom: 8px;
        }

        .summary-label {
            font-size: 14px;
            color: #4a6b8a;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .charts-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 24px;
            color: #003366;
            margin-bottom: 20px;
            font-weight: 600;
            border-bottom: 3px solid #e0e6ed;
            padding-bottom: 10px;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .chart {
            width: 100%;
            height: 400px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #003366;
            margin-bottom: 20px;
            text-align: center;
        }

        .analysis-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .analysis-content {
            line-height: 1.8;
            color: #4a6b8a;
        }

        .analysis-content p {
            margin-bottom: 15px;
        }

        .analysis-highlight {
            background-color: #e6f0ff;
            border-left: 4px solid #004d80;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .data-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            font-size: 18px;
            color: #4a6b8a;
        }

        .error-message {
            background-color: #ffe6e6;
            border: 1px solid #ffcccc;
            color: #d63031;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }

            .summary-cards {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .page-title {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-title">GNU Cash 财务记账软件</div>
            <div class="user-info">
                <span class="user-name" id="user-name">加载中...</span>
                <button class="logout-btn" onclick="logout()">退出登录</button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <h1 class="page-title">财务数据概览</h1>

        <!-- 数据加载中 -->
        <div class="data-loading" id="loading">
            <div>正在加载财务数据...</div>
        </div>

        <!-- 错误信息 -->
        <div class="error-message" id="error-message" style="display: none;">
            <div>加载数据失败，请稍后重试</div>
        </div>

        <!-- 主要内容 -->
        <div id="main-content" style="display: none;">
            <!-- 财务摘要卡片 -->
            <div class="summary-cards">
                <div class="summary-card positive">
                    <div class="summary-value" id="net-worth">¥0</div>
                    <div class="summary-label">净资产</div>
                </div>
                <div class="summary-card" id="income-card">
                    <div class="summary-value" id="month-income">¥0</div>
                    <div class="summary-label">本月收入</div>
                </div>
                <div class="summary-card negative" id="expense-card">
                    <div class="summary-value" id="month-expense">¥0</div>
                    <div class="summary-label">本月支出</div>
                </div>
                <div class="summary-card" id="cash-flow-card">
                    <div class="summary-value" id="cash-flow">¥0</div>
                    <div class="summary-label">本月现金流</div>
                </div>
            </div>

            <!-- 图表区域 -->
            <div class="charts-section">
                <h2 class="section-title">财务分析图表</h2>
                
                <div class="chart-grid">
                    <!-- 资产负债图表 -->
                    <div class="chart-container">
                        <div class="chart-title">资产负债分析</div>
                        <div id="assets-chart" class="chart"></div>
                    </div>

                    <!-- 账户余额分布 -->
                    <div class="chart-container">
                        <div class="chart-title">账户余额分布</div>
                        <div id="balances-chart" class="chart"></div>
                    </div>

                    <!-- 财务健康指标 -->
                    <div class="chart-container">
                        <div class="chart-title">财务健康指标</div>
                        <div id="health-chart" class="chart"></div>
                    </div>

                    <!-- 会计等式验证 -->
                    <div class="chart-container">
                        <div class="chart-title">会计等式分析</div>
                        <div id="accounting-chart" class="chart"></div>
                    </div>
                    
                    <!-- 财务平衡验证 -->
                    <div class="chart-container">
                        <div class="chart-title">财务平衡状态验证</div>
                        <div id="balance-verification-chart" class="chart"></div>
                    </div>

                    <!-- 月度财务趋势 -->
                    <div class="chart-container" style="grid-column: 1 / -1;">
                        <div class="chart-title">财务状况概览</div>
                        <div id="overview-chart" class="chart"></div>
                    </div>
                </div>
            </div>

            <!-- 数据分析 -->
            <div class="analysis-section">
                <h2 class="section-title">财务概览</h2>
                <div class="analysis-content">
                    <div id="analysis-text">
                        <!-- 内容将由JavaScript动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="echarts.min.js"></script>
    <script>
        // 检查登录状态
        function checkLoginStatus() {
            const userInfo = localStorage.getItem('currentUser');
            if (!userInfo) {
                alert('请先登录');
                window.location.href = 'login.html';
                return null;
            }
            
            try {
                const parsedInfo = JSON.parse(userInfo);
                // 确保返回的对象结构正确
                return {
                    id: parsedInfo.id,
                    username: parsedInfo.username,
                    password: parsedInfo.password
                };
            } catch (error) {
                alert('用户信息格式错误');
                window.location.href = 'login.html';
                return null;
            }
        }

        // 退出登录
        function logout() {
            localStorage.removeItem('userInfo');
            window.location.href = 'login.html';
        }

        // 获取仪表盘数据
        async function fetchDashboardData(userId) {
            try {
                const response = await fetch(`http://123.207.197.116:8081/api/dashboard/summary?userId=${userId}`);
                if (!response.ok) {
                    throw new Error('网络响应异常');
                }
                return await response.json();
            } catch (error) {
                console.error('获取仪表盘数据失败:', error);
                throw error;
            }
        }

        // 格式化金额
        function formatCurrency(amount) {
            return new Intl.NumberFormat('zh-CN', {
                style: 'currency',
                currency: 'CNY',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // 渲染摘要卡片
        function renderSummaryCards(data) {
            const overview = data.overview;
            
            document.getElementById('net-worth').textContent = formatCurrency(overview.netWorth);
            document.getElementById('month-income').textContent = formatCurrency(overview.monthIncome);
            document.getElementById('month-expense').textContent = formatCurrency(overview.monthExpense);
            document.getElementById('cash-flow').textContent = formatCurrency(overview.cashFlow);
            
            // 根据正负值设置卡片样式
            const cashFlowCard = document.getElementById('cash-flow-card');
            if (overview.cashFlow >= 0) {
                cashFlowCard.classList.add('positive');
                cashFlowCard.classList.remove('negative');
            } else {
                cashFlowCard.classList.add('negative');
                cashFlowCard.classList.remove('positive');
            }
        }

        // 渲染资产负债图表
        function renderAssetsChart(data) {
            const chart = echarts.init(document.getElementById('assets-chart'));
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        return params.name + ': ¥' + params.value.toLocaleString() + ' (' + params.percent + '%)';
                    }
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                },
                title: {
                    text: '财务结构分析',
                    left: 'center'
                },
                series: [
                    {
                        name: '财务结构',
                        type: 'pie',
                        radius: '60%',
                        center: ['50%', '50%'],
                        data: [
                            {value: data.balances.cash, name: '现金', itemStyle: {color: '#4CAF50'}},
                            {value: data.balances.deposit, name: '存款', itemStyle: {color: '#2196F3'}},
                            {value: data.accounting.liabilities, name: '负债', itemStyle: {color: '#F44336'}}
                        ],
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        },
                        label: {
                            formatter: function(params) {
                                return params.name + '\n¥' + params.value.toLocaleString() + '\n(' + params.percent + '%)';
                            }
                        }
                    }
                ]
            };
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        // 渲染账户余额分布图表
        function renderBalancesChart(data) {
            const chart = echarts.init(document.getElementById('balances-chart'));
            
            // 安全访问数据，提供默认值
            const cashData = data.cashBalances || data.balances || { cash: 0, deposit: 0 };
            
            const option = {
                title: {
                    text: '账户余额分布',
                    left: 'center',
                    textStyle: {
                        fontSize: 16,
                        color: '#333'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        return params[0].name + ': ¥' + params[0].value.toLocaleString();
                    }
                },
                xAxis: {
                    type: 'category',
                    data: ['现金', '存款']
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: function(value) {
                            return '¥' + (value / 1000).toFixed(0) + 'k';
                        }
                    }
                },
                series: [
                    {
                        data: [
                            {value: cashData.cash || 0, itemStyle: {color: '#4CAF50'}},
                            {value: cashData.deposit || 0, itemStyle: {color: '#2196F3'}}
                        ],
                        type: 'bar',
                        barWidth: '60%',
                        label: {
                            show: true,
                            position: 'top',
                            formatter: function(params) {
                                return '¥' + params.value.toLocaleString();
                            }
                        }
                    }
                ]
            };
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        // 渲染财务健康指标图表
        function renderHealthChart(data) {
            const chart = echarts.init(document.getElementById('health-chart'));
            const health = data.health || {};
            const monthly = data.monthly || {};
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        return params[0].name + ': ' + params[0].value.toFixed(1) + '%';
                    }
                },
                xAxis: {
                    type: 'category',
                    data: ['资产占比(%)', '负债占比(%)', '负债收入比(%)']
                },
                yAxis: {
                    type: 'value'
                },
                series: [
                    {
                        data: [
                            {value: health.assetRatio || 0, itemStyle: {color: '#4CAF50'}},
                            {value: health.liabilityRatio || 0, itemStyle: {color: '#F44336'}},
                            {value: ((health.debtToIncome || 0) * 100), itemStyle: {color: '#FF9800'}},
                            {value: ((monthly.savingRate || 0) * 100), itemStyle: {color: '#2196F3'}}
                        ],
                        type: 'bar',
                        barWidth: '60%',
                        label: {
                            show: true,
                            position: 'top',
                            formatter: function(params) {
                                return params.value.toFixed(1) + '%';
                            }
                        }
                    }
                ]
            };
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        // 渲染会计等式图表
        function renderAccountingChart(data) {
            const chart = echarts.init(document.getElementById('accounting-chart'));
            const accounting = data.accounting;
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        return params[0].name + ': ¥' + Math.abs(params[0].value).toLocaleString();
                    }
                },
                xAxis: {
                    type: 'category',
                    data: ['总资产', '总负债', '所有者权益', '总收入', '总支出']
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: function(value) {
                            return (Math.abs(value) / 10000).toFixed(1) + '万';
                        }
                    }
                },
                series: [
                    {
                        data: [
                            {value: accounting.assets, itemStyle: {color: '#4CAF50'}},
                            {value: -accounting.liabilities, itemStyle: {color: '#F44336'}},
                            {value: accounting.equity, itemStyle: {color: '#2196F3'}},
                            {value: accounting.income, itemStyle: {color: '#9C27B0'}},
                            {value: -accounting.expenses, itemStyle: {color: '#FF9800'}}
                        ],
                        type: 'bar',
                        barWidth: '60%',
                        label: {
                            show: true,
                            position: 'top',
                            formatter: function(params) {
                                return '¥' + Math.abs(params.value).toLocaleString();
                            }
                        }
                    }
                ]
            };
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        // 渲染财务平衡验证图表
        function renderBalanceVerificationChart(data) {
            const chart = echarts.init(document.getElementById('balance-verification-chart'));
            const accounting = data.accounting || {};
            
            // 确保数据安全访问
            const balances = {
                assets: accounting.assets || 0,
                liabilities: accounting.liabilities || 0,
                equity: accounting.equity || 0,
                income: accounting.income || 0,
                expenses: accounting.expenses || 0,
                calculatedNetWorth: accounting.calculatedNetWorth || 0,
                calculatedEquity: accounting.calculatedEquity || 0,
                difference: accounting.difference || 0,
                isBalanced: accounting.isBalanced || false,
                formula: accounting.formula || '资产 = 负债 + 权益 + (收入 - 支出)'
            };
            
            // 计算左侧（资产）和右侧（负债+权益+收入-支出）
            const leftSide = balances.assets;
            const rightSide = balances.liabilities + balances.equity + (balances.income - balances.expenses);
            
            // 用于显示的数据集
            const dataSet = [
                {name: '资产侧', value: leftSide, itemStyle: {color: '#4CAF50'}},
                {name: '负债权益侧', value: rightSide, itemStyle: {color: '#2196F3'}}
            ];
            
            // 平衡状态的视觉设计
            const balanceStatusColor = balances.isBalanced ? '#4CAF50' : '#F44336';
            const balanceStatusText = balances.isBalanced ? '平衡' : '不平衡';
            
            // 全新设计布局，采用更简洁清晰的结构，确保所有元素不重叠
            const option = {
                backgroundColor: '#ffffff',
           
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        return params.name + ': ¥' + params.value.toLocaleString();
                    }
                },
                // 移除默认图例，改用自定义文本标签
                series: [
                    {
                        // 顶部饼图 - 简化设计，居中放置
                        name: '会计恒等式两侧对比',
                        type: 'pie',
                        radius: ['15%', '25%'],
                        center: ['50%', '25%'],
                        avoidLabelOverlap: true,
                        label: {
                            show: false  // 完全隐藏饼图标签，避免与其他元素重叠
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: 16,
                                fontWeight: 'bold',
                                formatter: function(params) {
                                    return params.name + '\n¥' + params.value.toLocaleString();
                                }
                            }
                        },
                        data: dataSet
                    },
                    {
                        // 底部仪表盘 - 调整位置，减小与差额之间的距离
                        name: '平衡状态',
                        type: 'gauge',
                        center: ['50%', '70%'],
                        radius: '15%',
                        startAngle: 180,
                        endAngle: 0,
                        min: 0,
                        max: 1,
                        splitNumber: 1,
                        axisLine: {
                            lineStyle: {
                                width: 8,
                                color: [[1, balanceStatusColor]]
                            }
                        },
                        pointer: { show: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { show: false },
                        detail: {
                            formatter: balanceStatusText,
                            color: balanceStatusColor,
                            fontSize: 14
                        },
                        data: [{value: balances.isBalanced ? 1 : 0}]
                    }
                ],
                // 图形元素，使用垂直堆叠布局
                graphic: [
                    {
                        // 当前状态文本
                        type: 'text',
                        left: 'center',
                        top: '1%',
                        style: {
                            text: `当前状态: ${balanceStatusText}`,
                            fontSize: 14,
                            color: balanceStatusColor,
                            fontWeight: 'bold'
                        }
                    },
                    {
                        // 自定义图例 - 资产侧
                        type: 'group',
                        left: 'center',
                        top: '8%',
                        children: [
                            {
                                type: 'rect',
                                left: -120,
                                top: 0,
                                shape: {
                                    width: 12,
                                    height: 12
                                },
                                style: {
                                    fill: '#4CAF50'
                                }
                            },
                            {
                                type: 'text',
                                left: -105,
                                top: 0,
                                style: {
                                    text: '资产侧',
                                    fontSize: 14,
                                    fill: '#333'
                                }
                            },
                            {
                                type: 'rect',
                                left: -30,
                                top: 0,
                                shape: {
                                    width: 12,
                                    height: 12
                                },
                                style: {
                                    fill: '#2196F3'
                                }
                            },
                            {
                                type: 'text',
                                left: -15,
                                top: 0,
                                style: {
                                    text: '负债权益侧',
                                    fontSize: 14,
                                    fill: '#333'
                                }
                            },
                            {
                                type: 'rect',
                                left: 65,
                                top: 0,
                                shape: {
                                    width: 12,
                                    height: 12
                                },
                                style: {
                                    fill: balanceStatusColor
                                }
                            },
                            {
                                type: 'text',
                                left: 80,
                                top: 0,
                                style: {
                                    text: '平衡状态',
                                    fontSize: 14,
                                    fill: '#333'
                                }
                            }
                        ]
                    },
                    {
                        // 数据对比文本 - 在饼图下方
                        type: 'text',
                        left: 'center',
                        top: '55%',
                        style: {
                            text: `资产: ¥${leftSide.toLocaleString()} = 负债权益侧: ¥${rightSide.toLocaleString()}`,
                            fontSize: 14,
                            fill: '#666',
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            padding: [8, 16],
                            borderRadius: 4
                        },
                        z: 100
                    },
                    {
                        // 公式和差额信息合并在一行显示
                        type: 'text',
                        left: 'center',
                        top: '85%',
                        style: {
                            text: `${balances.formula}    差额: ¥${balances.difference.toLocaleString()}`,
                            fontSize: 16,
                            fontWeight: 'bold',
                            fill: '#333',
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            padding: [10, 20],
                            borderRadius: 8,
                            borderWidth: 2,
                            borderColor: '#ddd'
                        },
                        z: 100
                    }
                ]
            };
            
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        // 渲染财务概览图表
        function renderOverviewChart(data) {
            const chart = echarts.init(document.getElementById('overview-chart'));
            
            const option = {
                title: {
                    text: '月度财务概况',
                    left: 'center',
                    textStyle: {
                        fontSize: 16,
                        color: '#333'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        return params[0].name + ': ¥' + params[0].value.toLocaleString();
                    }
                },
                xAxis: {
                    type: 'category',
                    data: ['本月收入', '本月支出', '本月净现金流']
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: function(value) {
                            return '¥' + (value / 1000).toFixed(0) + 'k';
                        }
                    }
                },
                series: [
                    {
                        data: [
                            {value: data.overview.monthIncome, itemStyle: {color: '#4CAF50'}},
                            {value: data.overview.monthExpense, itemStyle: {color: '#F44336'}},
                            {value: data.overview.cashFlow, itemStyle: {color: data.overview.cashFlow >= 0 ? '#4CAF50' : '#F44336'}}
                        ],
                        type: 'bar',
                        barWidth: '60%',
                        label: {
                            show: true,
                            position: 'top',
                            formatter: function(params) {
                                return '¥' + params.value.toLocaleString();
                            }
                        }
                    }
                ]
            };
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        // 生成财务分析报告
        function generateAnalysisReport(data) {
            const overview = data.overview;
            const balances = data.balances;
            const health = data.health;
            const accounting = data.accounting;
            const monthly = data.monthly;
            
            // 确保所有必要的数据字段都存在
            if (!overview || !balances || !health || !accounting || !monthly) {
                throw new Error('数据不完整，无法生成分析报告');
            }
            
            // 简化分析报告内容，只显示关键财务指标
            const analysisTextElement = document.getElementById('analysis-text');
            
            // 清空原有内容
            while (analysisTextElement.firstChild) {
                analysisTextElement.removeChild(analysisTextElement.firstChild);
            }
            
            // 创建新的简化内容，显示所有关键财务指标
            const simplifiedContent = `
                <div class="analysis-highlight">
                    <strong>净资产：</strong>¥${overview.netWorth.toLocaleString()}
                </div>
                <p><strong>本月收入：</strong>¥${overview.monthIncome.toLocaleString()}</p>
                <p><strong>本月支出：</strong>¥${overview.monthExpense.toLocaleString()}</p>
                <p><strong>本月净现金流：</strong>¥${overview.cashFlow.toLocaleString()}</p>
                <p><strong>现金余额：</strong>¥${balances.cash.toLocaleString()}</p>
                <p><strong>存款余额：</strong>¥${balances.deposit.toLocaleString()}</p>
                <p><strong>流动资产总额：</strong>¥${balances.totalLiquid.toLocaleString()}</p>
                <p><strong>总资产：</strong>¥${accounting.assets.toLocaleString()}</p>
                <p><strong>总负债：</strong>¥${accounting.liabilities.toLocaleString()}</p>
                <p><strong>资产占比：</strong>${health.assetRatio}%</p>
                <p><strong>负债占比：</strong>${health.liabilityRatio}%</p>
                <p><strong>应急资金月数：</strong>${health.emergencyFund.toFixed(1)}个月</p>
                <p><strong>负债收入比：</strong>${(health.debtToIncome * 100).toFixed(1)}%</p>
                <p><strong>所有者权益：</strong>¥${accounting.equity.toLocaleString()}</p>
                <p><strong>总收入（历史累计）：</strong>¥${accounting.income.toLocaleString()}</p>
                <p><strong>总支出（历史累计）：</strong>¥${accounting.expenses.toLocaleString()}</p>
                <p><strong>计算净资产：</strong>¥${accounting.calculatedNetWorth.toLocaleString()}</p>
                <p><strong>会计等式验证：</strong>${accounting.formula}，${accounting.isBalanced ? '平衡' : '不平衡'}</p>
            `;
            
            analysisTextElement.innerHTML = simplifiedContent;
        }

        // 初始化页面
        async function initPage() {
            const userInfo = checkLoginStatus();
            if (!userInfo) return;
            
            // 显示用户信息
            document.getElementById('user-name').textContent = userInfo.username || '用户';
            
            try {
                // 获取数据 - 使用正确的userInfo.id
                const userId = userInfo.id;
                console.log('使用用户ID:', userId, '获取财务数据');
                
                const data = await fetchDashboardData(userId);
                
                // 隐藏加载状态，显示内容
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                
                // 渲染数据
                renderSummaryCards(data);
                renderAssetsChart(data);
                renderBalancesChart(data);
                renderHealthChart(data);
                renderAccountingChart(data);
                renderBalanceVerificationChart(data);
                renderOverviewChart(data);
                generateAnalysisReport(data);
                
                // 显示成功信息
                console.log('财务数据加载成功，所有字段已显示到图表中');
            } catch (error) {
                console.error('初始化页面时出错:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-message').innerHTML = `<div>接口调用失败，请检查网络连接或稍后重试</div><div style="margin-top: 10px; font-size: 14px; color: #999;">错误详情: ${error.message || '未知错误'}</div>`;
                document.getElementById('error-message').style.display = 'block';
            }
        }

        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>