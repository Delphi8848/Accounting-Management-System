<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè´¢åŠ¡åˆ†æåŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .ai-chat-container {
            display: flex;
            gap: 20px;
            height: 80vh;
            margin: 0 -10px;
        }

        .sidebar {
            flex: 1;
            min-width: 280px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .chat-area {
            flex: 2;
            min-width: 400px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }

        .history-sidebar {
            flex: 1;
            min-width: 280px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .welcome-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .welcome-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.8rem;
        }

        .welcome-section p {
            color: #666;
            line-height: 1.6;
            font-size: 1.1rem;
        }

        .classic-questions {
            margin-top: 30px;
        }

        .classic-questions h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .question-btn {
            display: block;
            width: 100%;
            padding: 12px 20px;
            margin: 8px 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-align: left;
        }

        .question-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .chat-history {
            margin-top: 30px;
            flex: 1;
            overflow-y: auto;
        }

        .chat-history h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .history-item {
            padding: 10px 15px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
        }

        .history-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #e9ecef;
        }

        .message {
            margin-bottom: 20px;
            padding: 15px 20px;
            border-radius: 15px;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        .user-message {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .ai-message {
            background: white;
            border: 1px solid #e9ecef;
            margin-right: auto;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* AIå›å¤å†…å®¹ç¾åŒ–æ ·å¼ */
        .ai-table {
            width: 100%;
            margin: 10px 0;
            border-collapse: collapse;
        }
        
        .table-row {
            display: flex;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .table-cell {
            flex: 1;
            padding: 8px 12px;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .table-cell:last-child {
            border-right: none;
        }
        
        .table-separator {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.1), transparent);
            margin: 8px 0;
        }
        
        .ai-list {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .ai-list li {
            margin: 5px 0;
            line-height: 1.6;
        }
        
        .ai-list ul, .ai-list ol {
            margin: 5px 0;
            padding-left: 20px;
        }

        .message-time {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        .input-area {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-btn {
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .clear-history {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .clear-history:hover {
            background: #c82333;
        }
        
        /* å†å²è®°å½•ä¸‹æ‹‰æ¡†æ ·å¼ */
        .history-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            background: white;
        }
        
        .history-select:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .history-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .new-chat-btn {
            flex: 1;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .new-chat-btn:hover {
            background: linear-gradient(135deg, #218838, #1e9e8a);
            transform: translateY(-1px);
        }
        
        .clear-history {
            flex: 1;
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .clear-history:hover {
            background: #c82333;
            transform: translateY(-1px);
        }
        
        /* å³ä¾§å†å²å¯¹è¯ç®¡ç†æ ·å¼ */
        .history-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
        }
        
        .history-header h3 {
            color: #667eea;
            font-size: 1.4rem;
            margin: 0;
        }
        
        .history-controls {
            margin-bottom: 25px;
        }
        
        .current-session-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .current-session-info h4 {
            color: #495057;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        #session-info {
            color: #6c757d;
            font-size: 0.9rem;
            word-break: break-word;
        }
        
        .history-stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #28a745;
        }
        
        .history-stats h4 {
            color: #495057;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }
        
        .stats-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .stats-item span:first-child {
            color: #6c757d;
        }
        
        .stats-item span:last-child {
            color: #495057;
            font-weight: 600;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .button-group button {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .button-group .new-chat-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .button-group .new-chat-btn:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .button-group .clear-history {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .button-group .clear-history:hover {
            background: linear-gradient(135deg, #ee7df7 0%, #f4455c 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AIè´¢åŠ¡åˆ†æåŠ©æ‰‹</h1>
            <p>åŸºäºæ‚¨çš„å®æ—¶è´¢åŠ¡æ•°æ®ï¼Œæä¾›ä¸“ä¸šçš„è´¢åŠ¡åˆ†æå’Œå»ºè®®</p>
        </div>

        <div class="ai-chat-container">
            <!-- å·¦ä¾§ï¼šé—®é¢˜æ¨è -->
            <div class="sidebar">
                <div class="welcome-section">
                    <h2>æ¬¢è¿ä½¿ç”¨è´¢åŠ¡åŠ©æ‰‹</h2>
                    <p>æˆ‘æ˜¯æ‚¨çš„ä¸“ä¸šè´¢åŠ¡é¡¾é—®ï¼Œæ‹¥æœ‰ç†è´¢ç»éªŒã€‚æˆ‘å°†åŸºäºæ‚¨çš„å®æ—¶è´¢åŠ¡æ•°æ®ï¼Œä¸ºæ‚¨æä¾›ä¸ªæ€§åŒ–çš„è´¢åŠ¡åˆ†æå’Œå»ºè®®ã€‚</p>
                </div>

                <div class="classic-questions">
                    <h3>ğŸ’¡ æ¥å’Œæˆ‘èŠå¤©å§</h3>
                    <button class="question-btn" onclick="askQuestion('è¯·åˆ†ææˆ‘çš„è´¢åŠ¡å¥åº·çŠ¶å†µ')">ğŸ“Š åˆ†ææˆ‘çš„è´¢åŠ¡å¥åº·çŠ¶å†µ</button>
                    <button class="question-btn" onclick="askQuestion('æˆ‘çš„æ”¶æ”¯ç»“æ„æ˜¯å¦åˆç†ï¼Ÿ')">ğŸ’° æ”¶æ”¯ç»“æ„åˆ†æ</button>
                    <button class="question-btn" onclick="askQuestion('è¯·ç»™æˆ‘ä¸€äº›é¢„ç®—ä¼˜åŒ–å»ºè®®')">ğŸ“ˆ é¢„ç®—ä¼˜åŒ–å»ºè®®</button>
                    <button class="question-btn" onclick="askQuestion('æˆ‘çš„è´¢åŠ¡å­˜åœ¨å“ªäº›é£é™©ï¼Ÿ')">âš ï¸ é£é™©è¯†åˆ«ä¸é¢„è­¦</button>
                    <button class="question-btn" onclick="askQuestion('å¦‚ä½•æé«˜æˆ‘çš„å‚¨è“„ç‡ï¼Ÿ')">ğŸ¯ å‚¨è“„æå‡ç­–ç•¥</button>
                    <button class="question-btn" onclick="askQuestion('è¯·å¸®æˆ‘æ£€æŸ¥ä¸€ä¸‹æˆ‘çš„è´¦ç›®æ˜¯å¦å¹³è¡¡ï¼Ÿ')">âš–ï¸ è´¦ç›®å¹³è¡¡æ£€æŸ¥</button>
                </div>
            </div>

            <!-- ä¸­é—´ï¼šèŠå¤©åŒºåŸŸ -->
            <div class="chat-area">
                <div class="messages-container" id="messages-container">
                    <div class="message ai-message">
                        <strong>AIè´¢åŠ¡é¡¾é—®ï¼š</strong><br>
                        æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ä¸“ä¸šè´¢åŠ¡é¡¾é—®ã€‚æˆ‘å·²ç»è·å–äº†æ‚¨çš„å®æ—¶è´¢åŠ¡æ•°æ®ï¼Œå¯ä»¥ä¸ºæ‚¨æä¾›ä»¥ä¸‹åˆ†ææœåŠ¡ï¼š<br><br>
                        â€¢ ğŸ“Š <strong>è´¢åŠ¡å¥åº·è¯Šæ–­</strong> - åˆ†æå‡€èµ„äº§ã€èµ„äº§è´Ÿå€ºç‡ç­‰å…³é”®æŒ‡æ ‡<br>
                        â€¢ ğŸ’° <strong>æ”¶æ”¯ç»“æ„åˆ†æ</strong> - è¯†åˆ«ä¸»è¦æ”¶å…¥æ¥æºå’Œæ”¯å‡ºç±»åˆ«<br>
                        â€¢ ğŸ“ˆ <strong>é¢„ç®—ä¸è§„åˆ’å»ºè®®</strong> - æä¾›é¢„ç®—ä¼˜åŒ–å’Œèµ„äº§é…ç½®æ–¹æ¡ˆ<br>
                        â€¢ âš ï¸ <strong>é£é™©è¯†åˆ«ä¸é¢„è­¦</strong> - å‘ç°æ½œåœ¨è´¢åŠ¡é£é™©<br><br>
                        æ‚¨å¯ä»¥ç›´æ¥æé—®ï¼Œæˆ–è€…ç‚¹å‡»å·¦ä¾§çš„ç»å…¸é—®é¢˜å¼€å§‹åˆ†æï¼
                        <div class="message-time">åˆšåˆš</div>
                    </div>
                </div>

                <div class="input-area">
                    <input type="text" class="message-input" id="message-input" placeholder="è¯·è¾“å…¥æ‚¨çš„è´¢åŠ¡é—®é¢˜..." onkeypress="handleKeyPress(event)">
                    <button class="send-btn" id="send-btn" onclick="sendMessage()">å‘é€</button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå†å²å¯¹è¯ç®¡ç† -->
            <div class="history-sidebar">
                <div class="history-header">
                    <h3>ğŸ’¬ å¯¹è¯ç®¡ç†</h3>
                </div>
                
                <div class="current-session-info">
                    <h4>ğŸ”„ å½“å‰ä¼šè¯</h4>
                    <div id="session-info">æ–°ä¼šè¯</div>
                </div>
                
                <div class="history-stats">
                    <h4>ğŸ“Š ä¼šè¯ç»Ÿè®¡</h4>
                    <div class="stats-item">
                        <span>æ¶ˆæ¯æ€»æ•°ï¼š</span>
                        <span id="current-messages">0</span>
                    </div>
                    <div class="stats-item">
                        <span>ä¼šè¯æ—¶é—´ï¼š</span>
                        <span id="session-time">-</span>
                    </div>
                </div>
                
                <div class="history-controls">
                    <div class="button-group">
                        <button class="new-chat-btn" onclick="startNewChat()">
                            <span style="margin-right: 5px;">â•</span>æ–°å¯¹è¯
                        </button>
                        <button class="clear-history" onclick="clearHistory()">
                            <span style="margin-right: 5px;">ğŸ—‘ï¸</span>æ¸…ç©ºå†å²
                        </button>
                    </div>
                </div>
                
                <div class="chat-history">
                    <h3>ğŸ“ å†å²å¯¹è¯</h3>
                    <div id="history-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://123.207.197.116:8081';
        let userData = null;
        let chatHistory = JSON.parse(localStorage.getItem('ai_chat_history') || '[]');
        let currentSession = [];
        let sessionId = Date.now().toString();
        let userId = 'user_' + Date.now(); // ç”Ÿæˆç”¨æˆ·ID

        // é¡µé¢åŠ è½½æ—¶è·å–ç”¨æˆ·æ•°æ®
        window.addEventListener('load', async () => {
            // ä»localStorageåŠ è½½å†å²å¯¹è¯
            const savedSession = JSON.parse(localStorage.getItem('aiChatSession') || 'null');
            if (savedSession) {
                currentSession = savedSession.messages || [];
                sessionId = savedSession.id || Date.now().toString();
                userId = savedSession.userId || 'user_' + Date.now();
                
                // æ˜¾ç¤ºå†å²å¯¹è¯
                displayHistoryMessages();
            } else {
                currentSession = [];
                sessionId = Date.now().toString();
                userId = 'user_' + Date.now();
            }
            
            await loadUserData();
            loadChatHistory();
            updateSessionInfo();
            updateStats();
        });
        
        // å¼€å§‹æ–°å¯¹è¯
        function startNewChat() {
            // æ¸…ç©ºlocalStorageä¸­çš„ä¼šè¯è®°å½•
            localStorage.removeItem('aiChatSession');
            
            // æ¸…ç©ºå½“å‰ä¼šè¯
            currentSession = [];
            sessionId = Date.now().toString();
            userId = 'user_' + Date.now();
            
            // æ¸…ç©ºèŠå¤©ç•Œé¢
            document.getElementById('messages-container').innerHTML = `
                <div class="message ai-message">
                    <strong>AIè´¢åŠ¡é¡¾é—®ï¼š</strong><br>
                    æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ä¸“ä¸šè´¢åŠ¡é¡¾é—®ã€‚æˆ‘å·²ç»è·å–äº†æ‚¨çš„å®æ—¶è´¢åŠ¡æ•°æ®ï¼Œå¯ä»¥ä¸ºæ‚¨æä¾›ä»¥ä¸‹åˆ†ææœåŠ¡ï¼š<br><br>
                    â€¢ ğŸ“Š <strong>è´¢åŠ¡å¥åº·è¯Šæ–­</strong> - åˆ†æå‡€èµ„äº§ã€èµ„äº§è´Ÿå€ºç‡ç­‰å…³é”®æŒ‡æ ‡<br>
                    â€¢ ğŸ’° <strong>æ”¶æ”¯ç»“æ„åˆ†æ</strong> - è¯†åˆ«ä¸»è¦æ”¶å…¥æ¥æºå’Œæ”¯å‡ºç±»åˆ«<br>
                    â€¢ ğŸ“ˆ <strong>é¢„ç®—ä¸è§„åˆ’å»ºè®®</strong> - æä¾›é¢„ç®—ä¼˜åŒ–å’Œèµ„äº§é…ç½®æ–¹æ¡ˆ<br>
                    â€¢ âš ï¸ <strong>é£é™©è¯†åˆ«ä¸é¢„è­¦</strong> - å‘ç°æ½œåœ¨è´¢åŠ¡é£é™©<br><br>
                    æ‚¨å¯ä»¥ç›´æ¥æé—®ï¼Œæˆ–è€…ç‚¹å‡»å·¦ä¾§çš„ç»å…¸é—®é¢˜å¼€å§‹åˆ†æï¼
                    <div class="message-time">åˆšåˆš</div>
                </div>
            `;
            
            // æ›´æ–°ç•Œé¢
            updateSessionInfo();
            updateStats();
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('message-input').value = '';
        }
        
        // æ›´æ–°å†å²è®°å½•ä¸‹æ‹‰æ¡†
        function updateHistorySelect() {
            const select = document.getElementById('history-select');
            select.innerHTML = '<option value="">é€‰æ‹©å†å²å¯¹è¯...</option>';
            
            chatHistory.forEach((session, index) => {
                const option = document.createElement('option');
                option.value = session.id;
                option.textContent = `${session.title} (${new Date(session.timestamp).toLocaleString()})`;
                select.appendChild(option);
            });
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats();
        }
        
        function updateStats() {
    // å®‰å…¨åœ°è·å–DOMå…ƒç´ 
    const currentMessagesElement = document.getElementById('current-messages');
    const sessionTimeElement = document.getElementById('session-time');
    
    // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
    if (!currentMessagesElement || !sessionTimeElement) {
        console.warn('ç»Ÿè®¡ä¿¡æ¯å…ƒç´ æœªæ‰¾åˆ°ï¼Œè·³è¿‡æ›´æ–°');
        return;
    }
    
    // è®¡ç®—æ€»æ¶ˆæ¯æ•°ï¼šæ¯ä¸ªå¯¹è¯åŒ…å«ç”¨æˆ·é—®é¢˜å’ŒAIå“åº”ï¼Œæ‰€ä»¥ä¹˜ä»¥2
    const totalMessages = currentSession.length * 2;
    
    currentMessagesElement.textContent = totalMessages;
    
    // æ›´æ–°ä¼šè¯æ—¶é—´
    if (currentSession.length > 0) {
        const firstMessage = currentSession[0];
        const sessionTime = new Date(firstMessage.timestamp).toLocaleString();
        sessionTimeElement.textContent = sessionTime;
    } else {
        sessionTimeElement.textContent = '-';
    }
}
        
        function displayHistoryMessages() {
    const messagesContainer = document.getElementById('messages-container');
    messagesContainer.innerHTML = '';
    
    currentSession.forEach(message => {
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        const userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'message user-message';
        userMessageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-text">${message.question}</div>
                <div class="message-time">${new Date(message.timestamp).toLocaleString()}</div>
            </div>
        `;
        messagesContainer.appendChild(userMessageDiv);
        
        // æ·»åŠ AIå›å¤
        const aiMessageDiv = document.createElement('div');
        aiMessageDiv.className = 'message ai-message';
        aiMessageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-text">${message.response}</div>
                <div class="message-time">${new Date(message.timestamp).toLocaleString()}</div>
            </div>
        `;
        messagesContainer.appendChild(aiMessageDiv);
    });
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function updateSessionInfo() {
    const sessionInfo = document.getElementById('session-info');
    
    // å®‰å…¨åœ°æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
    if (!sessionInfo) {
        console.warn('ä¼šè¯ä¿¡æ¯å…ƒç´ æœªæ‰¾åˆ°ï¼Œè·³è¿‡æ›´æ–°');
        return;
    }
    
    if (currentSession.length > 0) {
        const firstMessage = currentSession[0];
        const title = firstMessage.question || 'æ–°å¯¹è¯';
        const time = new Date(firstMessage.timestamp).toLocaleString();
        sessionInfo.innerHTML = `<strong>${title}</strong><br><small>åˆ›å»ºæ—¶é—´: ${time}</small>`;
    } else {
        sessionInfo.textContent = 'æ–°ä¼šè¯';
    }
}
        
        // åŠ è½½é€‰ä¸­çš„å†å²å¯¹è¯
        function loadSelectedHistory(sessionId) {
            if (!sessionId) return;
            
            const session = chatHistory.find(s => s.id === sessionId);
            if (!session) return;
            
            // è®¾ç½®å½“å‰ä¼šè¯
            currentSession = session.messages;
            sessionId = session.id;
            
            // æ¸…ç©ºèŠå¤©ç•Œé¢
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            
            // é‡æ–°æ˜¾ç¤ºå†å²æ¶ˆæ¯
            currentSession.forEach(msg => {
                addMessage(msg.response, 'ai');
            });
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // è·å–ç”¨æˆ·æ•°æ®
        async function loadUserData() {
            try {
                // ä»localStorageè·å–currentUserå¯¹è±¡å¹¶è§£æ
                const currentUserStr = localStorage.getItem('currentUser');
                let userId = '1'; // é»˜è®¤å€¼
                
                if (currentUserStr) {
                    const currentUser = JSON.parse(currentUserStr);
                    userId = currentUser.id || '1';
                }
                
                // è·å–æ¦‚è§ˆæ•°æ®
                const summaryResponse = await fetch(`${API_BASE}/api/dashboard/summary?userId=${userId}`);
                const summaryData = await summaryResponse.json();
                
                // è·å–äº¤æ˜“ç»Ÿè®¡æ•°æ®
                const statsResponse = await fetch(`${API_BASE}/api/transaction-stats?userId=${userId}`);
                const statsData = await statsResponse.json();
                
                // åˆå¹¶æ•°æ®
                userData = {
                    summary: summaryData,
                    stats: statsData
                };
                
                console.log('ç”¨æˆ·æ•°æ®åŠ è½½æˆåŠŸï¼Œç”¨æˆ·ID:', userId, 'æ•°æ®:', userData);
            } catch (error) {
                console.error('è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                userData = { summary: {}, stats: {} };
            }
        }

        // å¤„ç†AIå“åº”å†…å®¹ï¼Œå»é™¤markdownæ ¼å¼å¹¶ç¾åŒ–æ˜¾ç¤º
        function processAIResponse(content) {
            if (!content) return '';
            
            let processedContent = content;
            
            // å»é™¤å¸¸è§çš„markdownæ ¼å¼å­—ç¬¦
            processedContent = processedContent
                .replace(/### \*\*/g, '')  // å»é™¤### **
                .replace(/\*\*###/g, '')  // å»é™¤**###
                .replace(/\*\*/g, '')      // å»é™¤**
                .replace(/###/g, '')       // å»é™¤###
                .replace(/##/g, '')        // å»é™¤##
                .replace(/#/g, '')         // å»é™¤#
                .replace(/\*/g, '')        // å»é™¤*
                .replace(/`/g, '')         // å»é™¤`
                .replace(/\n{3,}/g, '\n\n'); // å¤šä¸ªæ¢è¡Œåˆå¹¶ä¸ºä¸¤ä¸ª
            
            // ç¾åŒ–è¡¨æ ¼æ˜¾ç¤º
            processedContent = processedContent.replace(/\|(.+?)\|/g, function(match) {
                // å¦‚æœæ˜¯è¡¨æ ¼è¡Œï¼Œæ·»åŠ è¡¨æ ¼æ ·å¼
                if (match.includes('---') || match.includes('|--')) {
                    return '<div class="table-separator"></div>';
                }
                return '<div class="table-row">' + match.replace(/\|/g, '<span class="table-cell">') + '</span></div>';
            });
            
            // å¤„ç†åˆ—è¡¨
            processedContent = processedContent.replace(/^(-|\*|\+)\s+(.+?)(?=\n|$)/gm, '<li>$2</li>');
            processedContent = processedContent.replace(/(<li>.*<\/li>)+/g, '<ul class="ai-list">$&</ul>');
            
            // å¤„ç†æ•°å­—åˆ—è¡¨
            processedContent = processedContent.replace(/^(\d+)\.\s+(.+?)(?=\n|$)/gm, '<li>$2</li>');
            processedContent = processedContent.replace(/(<li>.*<\/li>)+/g, '<ol class="ai-list">$&</ol>');
            
            // ä¿ç•™æ®µè½æ ¼å¼
            processedContent = processedContent.replace(/\n/g, '<br>');
            
            return processedContent;
        }
        
        // å‘é€æ¶ˆæ¯åˆ°AI
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();

            if (!message) return;

            if (!userData) {
                alert('ç”¨æˆ·æ•°æ®å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åé‡è¯•');
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
            addMessage(message, 'user');
            input.value = '';

            // åŠ¨æ€æ›´æ–°æ¶ˆæ¯æ•°ï¼ˆç”¨æˆ·é—®é¢˜+1ï¼‰
            updateStats();

            // å®‰å…¨åœ°è·å–å‘é€æŒ‰é’®
            const sendBtn = document.getElementById('send-btn');
            if (!sendBtn) {
                console.error('å‘é€æŒ‰é’®æœªæ‰¾åˆ°');
                return;
            }

            // ç¦ç”¨å‘é€æŒ‰é’®
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="loading"></div>';

            try {
                // å‡†å¤‡æ•°æ®
                const dataString = JSON.stringify(userData);

                // è°ƒç”¨AIæ¥å£
                const response = await fetch(`${API_BASE}/api/ai/chat?data=${encodeURIComponent(dataString)}&query=${encodeURIComponent(message)}`);
                const aiResponse = await response.text();

                // å¤„ç†AIå›å¤å†…å®¹
                const processedResponse = processAIResponse(aiResponse);

                // æ·»åŠ AIå›å¤åˆ°ç•Œé¢
                addMessage(processedResponse, 'ai');

                // åŠ¨æ€æ›´æ–°æ¶ˆæ¯æ•°ï¼ˆAIå“åº”+1ï¼‰
                updateStats();

                // ä¿å­˜åˆ°å½“å‰ä¼šè¯
                const messageData = {
                    question: message,
                    response: aiResponse,
                    timestamp: new Date().toISOString()
                };
                currentSession.push(messageData);

                // ä¿å­˜å®Œæ•´ä¼šè¯åˆ°localStorage
                const sessionData = {
                    id: sessionId,
                    userId: userId,
                    messages: [...currentSession],
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('aiChatSession', JSON.stringify(sessionData));

            } catch (error) {
                console.error('AIå¯¹è¯å¤±è´¥:', error);
                addMessage('æŠ±æ­‰ï¼ŒAIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'ai');
            } finally {
                // æ¢å¤å‘é€æŒ‰é’®
                sendBtn.disabled = false;
                sendBtn.textContent = 'å‘é€';
            }
        }

        // ç‚¹å‡»ç»å…¸é—®é¢˜
        function askQuestion(question) {
            document.getElementById('message-input').value = question;
            sendMessage();
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessage(content, type) {
            const container = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            const time = new Date().toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            if (type === 'user') {
                messageDiv.innerHTML = `
                    <strong>æ‚¨ï¼š</strong><br>${content}
                    <div class="message-time">${time}</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <strong>AIè´¢åŠ¡é¡¾é—®ï¼š</strong><br>${content.replace(/\n/g, '<br>')}
                    <div class="message-time">${time}</div>
                `;
            }
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // ä¿å­˜åˆ°å†å²è®°å½•
        function saveToHistory(question, answer) {
            const historyItem = {
                id: Date.now(),
                question: question,
                answer: answer,
                timestamp: new Date().toISOString()
            };
            
            chatHistory.unshift(historyItem);
            // åªä¿ç•™æœ€è¿‘20æ¡è®°å½•
            if (chatHistory.length > 20) {
                chatHistory = chatHistory.slice(0, 20);
            }
            
            localStorage.setItem('ai_chat_history', JSON.stringify(chatHistory));
            loadChatHistory();
        }

        // åŠ è½½èŠå¤©å†å²
        function loadChatHistory() {
            const historyList = document.getElementById('history-list');
            
            // å®‰å…¨åœ°æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!historyList) {
                console.warn('å†å²åˆ—è¡¨å…ƒç´ æœªæ‰¾åˆ°ï¼Œè·³è¿‡åŠ è½½å†å²è®°å½•');
                return;
            }
            
            historyList.innerHTML = '';
            
            chatHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <strong>${item.question}</strong>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                        ${new Date(item.timestamp).toLocaleDateString('zh-CN')}
                    </div>
                `;
                
                historyItem.onclick = () => {
                    // æ¸…ç©ºå½“å‰å¯¹è¯
                    const messagesContainer = document.getElementById('messages-container');
                    if (messagesContainer) {
                        messagesContainer.innerHTML = '';
                    }
                    // æ·»åŠ å†å²å¯¹è¯
                    addMessage(item.question, 'user');
                    addMessage(item.answer, 'ai');
                };
                
                historyList.appendChild(historyItem);
            });
        }

        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©å†å²å—ï¼Ÿ')) {
                chatHistory = [];
                localStorage.setItem('ai_chat_history', JSON.stringify(chatHistory));
                loadChatHistory();
            }
        }

        // å›è½¦å‘é€æ¶ˆæ¯
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // åˆå§‹åŒ–
        loadChatHistory();
    </script>
</body>
</html>